<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Booking Test UI</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.4.1/socket.io.js"></script>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
        #seatMap { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-top: 20px; }
        .seat { padding: 10px; text-align: center; background-color: #e0e0e0; cursor: pointer; }
        .seat.selected { background-color: #4CAF50; color: white; }
        .seat.booked { background-color: #f44336; color: white; cursor: not-allowed; }
        #bookingForm { margin-top: 20px; }
        #bookingStatus { margin-top: 20px; font-weight: bold; }
    </style>
</head>
<body>
    <h1>Booking Test UI</h1>
    <div id="seatMap"></div>
    <div id="bookingForm">
        <button id="bookBtn">Book Selected Seats</button>
    </div>
    <div id="bookingStatus"></div>

    <script>
        const socket = io('http://localhost:5000'); // Adjust the URL to match your server
        const seatMap = document.getElementById('seatMap');
        const bookBtn = document.getElementById('bookBtn');
        const bookingStatus = document.getElementById('bookingStatus');
        let selectedSeats = [];

        // Create seat map
        for (let i = 1; i <= 40; i++) {
            const seat = document.createElement('div');
            seat.className = 'seat';
            seat.textContent = i;
            seat.onclick = () => toggleSeatSelection(i, seat);
            seatMap.appendChild(seat);
        }

        function toggleSeatSelection(seatNumber, seatElement) {
            if (seatElement.classList.contains('booked')) return;
            
            if (selectedSeats.includes(seatNumber)) {
                selectedSeats = selectedSeats.filter(num => num !== seatNumber);
                seatElement.classList.remove('selected');
            } else {
                selectedSeats.push(seatNumber);
                seatElement.classList.add('selected');
            }
        }

        bookBtn.onclick = async () => {
            if (selectedSeats.length === 0) {
                alert('Please select at least one seat.');
                return;
            }

            const tripId = '66bc65487c951d848da2fec3'; 
            try {
                const response = await fetch('http://localhost:5000/api/bookings', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpZCI6IjY2YmM2ODdkZDgzZDllYmM5NDllNjhhZCIsInVzZXJOYW1lIjoidXNlciIsImZ1bGxOYW1lIjoiVHJhbiBUaGUgVGhhbmgiLCJwaG9uZU51bWJlciI6IjEyMyIsImVtYWlsIjoidHJhbnRoZXRoYW5oODUyMDAyQGdtYWlsLmNtIiwicm9sZUlkIjoidXNlciIsImFkZHJlc3MiOiJBZG1pbiBBZGRyZXNzIiwiaWF0IjoxNzIzNzc3MTg0LCJleHAiOjE3MjM3ODA3ODR9.QtApxLYdi-3YKxjqtNeO7jQonrDY4Uf1y9LgtcR39_k',  // Replace with actual JWT token
                    },
                    body: JSON.stringify({ tripId, seatNumbers: selectedSeats }),
                });

                const result = await response.json();

                if (response.ok) {
                    bookingStatus.textContent = `Successfully booked seats: ${selectedSeats.join(', ')}`;
                    selectedSeats.forEach(seatNumber => {
                        const seatElement = seatMap.children[seatNumber - 1];
                        seatElement.classList.remove('selected');
                        seatElement.classList.add('booked');
                    });
                    selectedSeats = [];
                } else {
                    bookingStatus.textContent = `Booking failed: ${result.message}`;
                }
            } catch (error) {
                bookingStatus.textContent = 'An error occurred while booking seats. Please try again.';
                console.error('Error:', error);
            }
        };

        socket.on('seatsBooked', (data) => {
            console.log('Seats booked:', data);
            data.seatNumbers.forEach(seatNumber => {
                const seatElement = seatMap.children[seatNumber - 1];
                seatElement.classList.remove('selected');
                seatElement.classList.add('booked');
            });
            bookingStatus.textContent = `Seats ${data.seatNumbers.join(', ')} have been booked.`;
        });
    </script>
</body>
</html>
