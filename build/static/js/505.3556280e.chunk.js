"use strict";(self.webpackChunkclient=self.webpackChunkclient||[]).push([[505],{89505:(e,t,r)=>{r.r(t),r.d(t,{default:()=>p});var s=r(65043),a=r(73216),i=r(65868),l=r(83003),n=r(42104),o=r(10254),c=r(70579);const d=e=>{let{trip:t,onToggle:r,isOpen:s,loading:a}=e;return(0,c.jsxs)("div",{className:"bg-white shadow-lg rounded-lg p-4 mb-4",children:[(0,c.jsxs)("div",{className:"flex justify-between items-center border-b pb-3",children:[(0,c.jsxs)("div",{className:"flex flex-col items-start text-left",children:[(0,c.jsx)("p",{className:"text-lg font-semibold text-gray-800",children:new Date(t.departureTime).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})}),(0,c.jsx)("p",{className:"text-xl text-gray-600",children:t.departureLocation.name})]}),(0,c.jsx)("div",{className:"text-center text-gray-500 text-sm",children:(0,c.jsxs)("p",{children:[Math.round((new Date(t.arrivalTime)-new Date(t.departureTime))/36e5)," gi\u1edd"]})}),(0,c.jsxs)("div",{className:"flex flex-col items-end text-right",children:[(0,c.jsx)("p",{className:"text-lg font-semibold text-gray-800",children:new Date(t.arrivalTime).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})}),(0,c.jsx)("p",{className:"text-xl text-gray-600",children:t.arrivalLocation.name})]})]}),(0,c.jsxs)("div",{className:"flex justify-between items-center mt-3",children:[(0,c.jsxs)("div",{className:"relative flex-shrink-0 hidden sm:block w-24 h-24 rounded-lg overflow-hidden",children:[(0,c.jsx)("img",{src:t.busType.image||"https://static.vexere.com/production/images/1702527338553.jpeg",alt:"Bus",className:"w-full h-full object-cover"}),(0,c.jsx)("div",{className:"absolute top-1 left-1 bg-green-500 text-white text-xs px-2 py-1 rounded",children:"X\xe1c nh\u1eadn ngay"})]}),(0,c.jsxs)("div",{className:"flex flex-col items-start sm:ml-4 flex-1",children:[(0,c.jsx)("h3",{className:"font-semibold text-lg sm:text-base",children:t.busType.name}),(0,c.jsxs)("p",{className:"mt-2 text-green-600",children:[t.availableSeats," gh\u1ebf c\xf2n tr\u1ed1ng"]})]}),(0,c.jsx)("div",{className:"text-right",children:(0,c.jsxs)("p",{className:"text-xl font-bold text-blue-600",children:[(0,o.v)(t.basePrice)," VND"]})})]}),(0,c.jsxs)("div",{className:"flex justify-between items-center mt-4",children:[(0,c.jsx)("button",{onClick:r,className:"w-full sm:w-auto bg-yellow-500 text-white px-4 py-2 rounded-lg hover:bg-yellow-600 transition duration-300",disabled:a,children:s?"\u1ea8n chi ti\u1ebft":"Ch\u1ecdn chuy\u1ebfn"}),(0,c.jsx)("p",{className:"text-xs text-gray-500 mt-2 sm:mt-0 pl-3",children:"KH\xd4NG Y\xcaU C\u1ea6U THANH TO\xc1N TR\u01af\u1edaC"})]})]})};var u=r(17137),m=r(75088);const x=e=>{let{seatsData:t,isLoadingSeats:r,handleSeatSelect:s,selectedSeats:a,lockTimers:i,loading:l,totalPrice:n,handleContinue:d,error:x,userId:h}=e;const g=e=>a.includes(e.seatNumber)?"bg-green-500 text-white":e.lockedBy&&e.lockedBy!==h?"bg-orange-500 text-white":1===e.seatNumber?"bg-gray-500 text-white cursor-not-allowed":[2,3,4,5,6].includes(e.seatNumber)?"bg-yellow-500 text-white":e.isAvailable?"bg-green-100 border-2 border-green-500":"bg-red-500 text-white",p=(e,t)=>(0,c.jsxs)("div",{className:"mb-4",children:[(0,c.jsx)("h4",{className:"font-semibold text-center mb-3 text-gray-700",children:t}),(0,c.jsx)("div",{className:"grid grid-cols-5 gap-3",children:e.map((e=>(0,c.jsxs)("button",{onClick:()=>s(e.seatNumber),disabled:l,className:`w-12 h-12 rounded-lg text-center text-sm font-semibold \n              cursor-pointer ${g(e)}`,children:[e.seatNumber,i[e.seatNumber]&&(0,c.jsx)(m.A,{className:"absolute -top-1 -right-1 h-4 w-4"})]},e._id)))})]});return(0,c.jsx)(u.e,{show:!0,enter:"transition-opacity duration-300",enterFrom:"opacity-0",enterTo:"opacity-100",leave:"transition-opacity duration-300",leaveFrom:"opacity-100",leaveTo:"opacity-0",children:(0,c.jsxs)("div",{className:"border-t mt-4 pt-4 space-y-6",children:[(0,c.jsxs)("div",{className:"flex flex-row flex-wrap justify-around space-x-4 mb-4 text-sm text-gray-700",children:[(0,c.jsxs)("div",{className:"flex items-center mb-2",children:[(0,c.jsx)("div",{className:"w-4 h-4 bg-gray-500 mr-2 rounded"}),"Gh\u1ebf kh\xf4ng kh\u1ea3 d\u1ee5ng"]}),(0,c.jsxs)("div",{className:"flex items-center mb-2",children:[(0,c.jsx)("div",{className:"w-4 h-4 bg-yellow-500 mr-2 rounded"}),"Gh\u1ebf VIP"]}),(0,c.jsxs)("div",{className:"flex items-center mb-2",children:[(0,c.jsx)("div",{className:"w-4 h-4 bg-green-500 mr-2 rounded"}),"\u0110\xe3 ch\u1ecdn"]}),(0,c.jsxs)("div",{className:"flex items-center mb-2",children:[(0,c.jsx)("div",{className:"w-4 h-4 bg-orange-500 mr-2 rounded"}),"T\u1ea1m th\u1eddi gi\u1eef"]}),(0,c.jsxs)("div",{className:"flex items-center mb-2",children:[(0,c.jsx)("div",{className:"w-4 h-4 border border-green-500 bg-green-100 mr-2 rounded"}),"C\xf3 s\u1eb5n"]}),(0,c.jsxs)("div",{className:"flex items-center mb-2",children:[(0,c.jsx)("div",{className:"w-4 h-4 bg-red-500 mr-2 rounded"}),"\u0110\xe3 \u0111\u1eb7t"]})]}),(0,c.jsxs)("div",{className:"flex w-full",children:[(0,c.jsx)("div",{className:`w-full ${t.upper?"md:w-1/2":""} pr-4`,children:p(t.lower,"T\u1ea7ng D\u01b0\u1edbi")}),t.upper&&(0,c.jsx)("div",{className:"w-full md:w-1/2 pl-4",children:p(t.upper,"T\u1ea7ng Tr\xean")})]}),(0,c.jsxs)("div",{className:"mt-6 flex justify-between items-center border-t pt-4",children:[(0,c.jsxs)("div",{className:"text-sm text-gray-700",children:["Gh\u1ebf \u0111\xe3 ch\u1ecdn: ",(0,c.jsx)("span",{className:"font-medium",children:a.join(", ")})]}),(0,c.jsxs)("div",{className:"text-lg font-semibold text-gray-900",children:["T\u1ed5ng: ",(0,o.v)(n)," VND"]}),(0,c.jsx)("button",{onClick:d,disabled:0===a.length||l,className:"px-6 py-2 rounded-lg text-white transition duration-300\n              "+(0===a.length||l?"bg-gray-400 cursor-not-allowed":"bg-blue-600 hover:bg-blue-700"),children:"Ti\u1ebfp t\u1ee5c"})]}),x&&(0,c.jsx)("p",{className:"text-red-500 mt-2",children:x})]})})},h=e=>{let{trip:t,isOpen:r,onToggle:o}=e;const u=(0,a.Zp)(),m=(0,s.useRef)(null),h=(0,l.d4)((e=>e.user.userInfo)),g=null===h||void 0===h?void 0:h.id,[p,b]=(0,s.useState)([]),[f,v]=(0,s.useState)({lower:[],upper:[]}),[N,j]=(0,s.useState)({}),[y,w]=(0,s.useState)(null),[T,k]=(0,s.useState)(!1),{data:S,isLoading:D}=(0,i.BX)(t._id,{skip:!r}),P=(0,s.useCallback)((()=>{try{return m.current=(0,n.Ay)("https://server-zeym.onrender.com",{reconnection:!0,reconnectionAttempts:5,reconnectionDelay:1e3}),m.current.on("connect",(()=>{console.log("Connected to socket server"),r&&t._id&&(m.current.emit("joinTrip",t._id),console.log(`Joining trip room: ${t._id}`))})),m.current.on("connect_error",(e=>{console.error("Socket connection error:",e),w("Unable to connect to booking service. Please try again later.")})),()=>{m.current&&m.current.disconnect()}}catch(y){console.error("Socket setup error:",y),w("Unable to initialize booking service. Please try again later.")}}),[t._id,r]);(0,s.useEffect)((()=>{S&&(v(S.data),w(null))}),[S]),(0,s.useEffect)((()=>{m.current||P();const e=m.current,t=e=>{let{seatNumber:t,lockedBy:r,lockExpiration:s}=e;v((e=>({lower:e.lower.map((e=>e.seatNumber===t?{...e,isAvailable:!1,lockedBy:r,lockExpiration:s}:e)),upper:e.upper.map((e=>e.seatNumber===t?{...e,isAvailable:!1,lockedBy:r,lockExpiration:s}:e))})))},r=e=>{let{seatNumber:t}=e;v((e=>({lower:e.lower.map((e=>e.seatNumber===t?{...e,isAvailable:!0,lockedBy:null}:e)),upper:e.upper.map((e=>e.seatNumber===t?{...e,isAvailable:!0,lockedBy:null}:e))}))),N[t]&&(clearTimeout(N[t]),j((e=>{const r={...e};return delete r[t],r})))},s=e=>{let{type:t,message:r}=e;w(r),k(!1),"RESERVE_ERROR"===t&&b((e=>e.filter((e=>!e.includes(r.seatNumber)))))};return e.on("seatLocked",t),e.on("seatReleased",r),e.on("error",s),e.on("seatUnavailable",(e=>{let{seatNumber:t}=e;w(`Gh\u1ebf s\u1ed1 ${t} kh\xf4ng kh\u1ea3 d\u1ee5ng`),b((e=>e.filter((e=>e!==t))))})),()=>{e.off("seatLocked",t),e.off("seatReleased",r),e.off("error",s),e.off("seatUnavailable"),Object.values(N).forEach(clearTimeout)}}),[g,t._id,P,N]),(0,s.useEffect)((()=>{r&&t._id&&m.current.emit("joinTrip",t._id)}),[r]);const _=(0,s.useCallback)((async e=>{if(g){k(!0),w(null);try{if(console.log("Selected seat number:",e),p.includes(e)){const r=[...f.lower,...f.upper].find((t=>t.seatNumber===e));if(!r.isAvailable&&r.lockedBy&&r.lockedBy!==g)return void w(`Seat ${e} is temporarily reserved by another user`);console.log("Releasing seat:",e),m.current.emit("releaseSeat",{tripId:t._id,seatNumber:e,userId:g}),b((t=>t.filter((t=>t!==e))))}else console.log("Reserving seat:",e),m.current.emit("reserveSeat",{tripId:t._id,seatNumber:e,userId:g}),b((t=>[...t,e]))}catch(y){console.error("Error in seat selection:",y),w("Failed to process seat selection. Please try again.")}finally{k(!1)}}else w("Please log in to select seats")}),[t._id,g,f,p]),C=(0,s.useCallback)((()=>{0!==p.length?u("/bookingconfirmation",{state:{selectedSeats:p,totalPrice:p.length*t.basePrice,trip:t}}):w("Please select at least one seat to continue")}),[u,p,t]);return(0,c.jsxs)("div",{className:"bg-white rounded-lg shadow-lg mb-6 p-4 hover:shadow-xl transition-shadow duration-300",children:[(0,c.jsx)(d,{trip:t,onToggle:o,isOpen:r,loading:T}),r&&(0,c.jsx)(x,{seatsData:f,isLoadingSeats:D,handleSeatSelect:_,selectedSeats:p,lockTimers:N,loading:T,totalPrice:p.length*t.basePrice,handleContinue:C,error:y,userId:g})]})};var g=r(16181);const p=e=>{let{filters:t={}}=e;const r=(0,a.zy)(),l=new URLSearchParams(r.search),n=l.get("departureLocation"),o=l.get("arrivalLocation"),d=l.get("departureDate"),u=l.get("returnDate"),m=l.get("ticketCount"),[x,p]=(0,s.useState)([]),[b,f]=(0,s.useState)([]),[v,N]=(0,s.useState)(!0),[j,y]=(0,s.useState)([]),[w,T]=(0,s.useState)(0),[k,S]=(0,s.useState)(null),{data:D,error:P,isLoading:_}=(0,i.pg)({departureLocation:n,arrivalLocation:o,departureDate:d,returnDate:u,ticketCount:m});if((0,s.useEffect)((()=>{var e;null!==D&&void 0!==D&&null!==(e=D.data)&&void 0!==e&&e.departureTrips&&(f(D.data.departureTrips),p(D.data.departureTrips))}),[D]),(0,s.useEffect)((()=>{N(!0);const e=setTimeout((()=>{(()=>{let e=[...b];"low"===t.priceRange?e=e.filter((e=>e.basePrice<2e5)):"medium"===t.priceRange?e=e.filter((e=>e.basePrice>=2e5&&e.basePrice<=5e5)):"high"===t.priceRange&&(e=e.filter((e=>e.basePrice>5e5))),t.busOperator&&(e=e.filter((e=>{var r;return(null===(r=e.busType)||void 0===r?void 0:r.name)===t.busOperator}))),"morning"===t.departureTimeRange?e=e.filter((e=>{const t=new Date(e.departureTime).getHours();return t>=6&&t<12})):"afternoon"===t.departureTimeRange&&(e=e.filter((e=>{const t=new Date(e.departureTime).getHours();return t>=12&&t<18}))),"priceAsc"===t.sort?e.sort(((e,t)=>e.basePrice-t.basePrice)):"priceDesc"===t.sort?e.sort(((e,t)=>t.basePrice-e.basePrice)):"earliest"===t.sort?e.sort(((e,t)=>new Date(e.departureTime)-new Date(t.departureTime))):"latest"===t.sort&&e.sort(((e,t)=>new Date(t.departureTime)-new Date(e.departureTime))),p(e),N(!1)})()}),500);return()=>clearTimeout(e)}),[t,b]),!n||!o||!d)return(0,c.jsx)("div",{children:"Thi\u1ebfu th\xf4ng tin t\xecm ki\u1ebfm. Vui l\xf2ng th\u1eed l\u1ea1i."});if(v||_)return(0,c.jsx)("div",{className:"container mx-auto py-8",children:(0,c.jsx)(g.A,{})});if(P)return(0,c.jsxs)("div",{children:["Kh\xf4ng t\xecm th\u1ea5y chuy\u1ebfn xe. L\u1ed7i: ",P.message]});if(0===x.length)return(0,c.jsx)("div",{children:"Kh\xf4ng t\xecm th\u1ea5y chuy\u1ebfn xe n\xe0o ph\xf9 h\u1ee3p v\u1edbi y\xeau c\u1ea7u t\xecm ki\u1ebfm c\u1ee7a b\u1ea1n."});const C=(e,t,r)=>{y(e),T(t),S(r)};return(0,c.jsxs)("div",{className:"container mx-auto py-8",children:[(0,c.jsx)("h2",{className:"text-2xl font-bold mb-4",children:"K\u1ebft qu\u1ea3 t\xecm ki\u1ebfm chuy\u1ebfn xe"}),(0,c.jsx)("div",{className:"space-y-4",children:x.map((e=>(0,c.jsx)(h,{trip:e,isOpen:e._id===(null===k||void 0===k?void 0:k._id),onToggle:()=>{S((null===k||void 0===k?void 0:k._id)===e._id?null:e)},onContinue:C},e._id)))})]})}},10254:(e,t,r)=>{r.d(t,{D:()=>i,v:()=>l});var s=r(34348),a=r.n(s);const i={parseUTCTimeForForm:e=>e?new Date(e):new Date,formatTimeForServer:e=>e?a()(e).utc().format():null,formatDisplayTime:e=>e?a()(e).tz("Asia/Ho_Chi_Minh").format("DD/MM/YYYY HH:mm"):""},l=e=>e?new Intl.NumberFormat("vi-VN",{style:"currency",currency:"VND"}).format(e):"0 VND"}}]);
//# sourceMappingURL=505.3556280e.chunk.js.map